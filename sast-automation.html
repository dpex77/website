<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAST Semgrep Scan</title>
<style>
body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; background: #f4f4f9; color: #222; }
h1, h2, h3 { color: #222; }
h1 { text-align: center; }
pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; overflow-x: auto; }
code { background: #eee; padding: 2px 4px; border-radius: 3px; }
hr { border: 0; border-top: 1px solid #ccc; margin: 40px 0; }
#toc { background: #f0f0f0; padding: 20px; border-radius: 8px; }
#toc ul { list-style-type: none; padding-left: 0; }
#toc li { margin: 5px 0; }
</style>
</head>
<body>

<div id="toc">
<h1>Table of Contents</h1>
<ul>
<li><a href="#readme">Readme</a></li>
<li><a href="#script">Script</a></li>
<li><a href="#vul-server-example">Vulnerable Server Example</a></li>
<li><a href="#execution">Execution</a></li>
</ul>
</div>

<hr>

<h2 id="readme">Readme</h2>
<p>SAST scanning is using <strong>Semgrep</strong> here as a tool.</p>

<hr>

<h2 id="script">Script</h2>
<pre>
import subprocess
import requests
import os

# -------------------------
# CONFIGURATION
# -------------------------
TARGET_PATH = "/home/dipesh/SAST"  # Folder containing Python files
SEMGREP_CONFIG = "p/python"        # Semgrep config
SEMGRP_JSON = "/tmp/semgrep_results.json"  # Temporary file

# DefectDojo
DEFECTDOJO_URL = "http://192.168.209.138:8080"
ENGAGEMENT_ID = 3
API_KEY = "XXXXXXXX"  # Replace with your API key

# -------------------------
# Run Semgrep scan
# -------------------------
print(f"Running Semgrep scan on {TARGET_PATH}...")
env = os.environ.copy()
env["SEMGREP_HOME"] = "/tmp/semgrep"  # Avoid read-only issues

subprocess.run([
    "/home/dipesh/SAST/env/bin/semgrep",
    "--config", SEMGREP_CONFIG,
    TARGET_PATH,
    "--json",
    "-o", SEMGRP_JSON
], check=True, env=env)

print(f"Semgrep scan completed. Results saved to {SEMGRP_JSON}")

# -------------------------
# Upload to DefectDojo
# -------------------------
print("Uploading results to DefectDojo...")

headers = {"Authorization": f"Token {API_KEY}"}

files = {
    'file': ('semgrep_results.json', open(SEMGRP_JSON, 'rb'), 'application/json')
}

data = {
    'engagement': ENGAGEMENT_ID,
    'scan_type': 'Semgrep JSON Report',  # Correct scan type in DefectDojo
    'minimum_severity': 'Low',
    'active': 'true',
    'verified': 'true',
    'tags': 'semgrep,python'
}

upload_url = f"{DEFECTDOJO_URL}/api/v2/import-scan/"

response = requests.post(upload_url, headers=headers, files=files, data=data, verify=False)

if response.status_code in [200, 201]:
    print("Scan successfully uploaded to DefectDojo!")
else:
    print(f"Failed to upload scan. Status: {response.status_code}")
    print(response.text)
</pre>

<hr>

<h2 id="vul-server-example">Vulnerable Server Example</h2>
<pre>
import os
import pickle
import subprocess
import yaml

# Hardcoded secret (bad practice)
API_KEY = "AKIA123456SECRETKEY"

# Command injection vulnerability
def run_command(user_input):
    os.system("echo " + user_input)

# Insecure subprocess usage
def ping_host(host):
    subprocess.call("ping -c 1 " + host, shell=True)

# Insecure YAML deserialization
def load_config(data):
    return yaml.load(data, Loader=yaml.FullLoader)  # unsafe

# Insecure pickle deserialization
def load_pickle(data):
    return pickle.loads(data)  # unsafe

# Example usage
if __name__ == "__main__":
    run_command("hello; rm -rf /")  # Injection
    ping_host("127.0.0.1; rm -rf /")
    config = load_config("!!python/object/apply:os.system ['ls']")
    print(config)
</pre>

<hr>

<h2 id="execution">Execution</h2>
<pre>
root@test-server:/home/dipesh/SAST# python3 sastscript.py
Running Semgrep scan on /home/dipesh/SAST...

‚îå‚îÄ‚îÄ‚îÄ‚îÄ ‚óã‚óã‚óã ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Semgrep CLI ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

/home/dipesh/SAST/env/lib/python3.12/site-packages/opentelemetry/instrumentation/dependencies.py:4: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
  from pkg_resources import (

Scanning 4650 files (only git-tracked) with 151 Code rules:

  CODE RULES
  Scanning 2107 files with 151 python rules.

  SUPPLY CHAIN RULES

  üíé Sign in with `semgrep login` and run
     `semgrep ci` to find dependency vulnerabilities and
     advanced cross-file findings.

  PROGRESS

  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚ï∏ 100% 0:02:05

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Scan Summary ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚úÖ Scan completed successfully.
 ‚Ä¢ Findings: 44 (44 blocking)
 ‚Ä¢ Rules run: 151
 ‚Ä¢ Targets scanned: 2107
 ‚Ä¢ Parsed lines: ~100.0%
 ‚Ä¢ Scan skipped:
   ‚ó¶ Files larger than  files 1.0 MB: 3
   ‚ó¶ Files matching .semgrepignore patterns: 179
 ‚Ä¢ For a detailed list of skipped files and lines, run semgrep with the --verbose flag
Ran 151 rules on 2107 files: 44 findings.
üíé Missed out on 637 pro rules since you aren't logged in!
‚ö° Supercharge Semgrep OSS when you create a free account at https://sg.run/rules.

üì¢ Too many findings? Try Semgrep Pro for more powerful queries and less noise.
   See https://sg.run/false-positives.
Semgrep scan completed. Results saved to /tmp/semgrep_results.json
Uploading results to DefectDojo...
Scan successfully uploaded to DefectDojo!
</pre>

</body>
</html>
