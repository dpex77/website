<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SAST Semgrep Lab</title>
  <style>
    body {
      font-family: monospace, monospace;
      background: #fff;
      color: #000;
      margin: 40px;
      line-height: 1.5;
    }
    h1, h2, h3 {
      text-align: center;
      text-transform: uppercase;
    }
    pre {
      background: #f4f4f4;
      border: 1px solid #000;
      padding: 10px;
      overflow-x: auto;
    }
    code {
      font-family: monospace;
    }
    .section {
      margin-bottom: 40px;
    }
    .log {
      background: #eee;
      border-left: 4px solid #000;
      padding: 10px;
      margin: 10px 0;
    }
  </style>
</head>
<body>

<h1>SAST Semgrep Proof-of-Concept Lab</h1>

<div class="section">
<h2>Readme</h2>
<p>
SAST scanning is performed using <strong>Semgrep</strong> to find vulnerabilities in Python code.
</p>
</div>

<div class="section">
<h2>Script (sastscript.py)</h2>
<pre><code>import subprocess
import requests
import os

# -------------------------
# CONFIGURATION
# -------------------------
TARGET_PATH = "/home/dipesh/SAST"
SEMGREP_CONFIG = "p/python"
SEMGRP_JSON = "/tmp/semgrep_results.json"

# DefectDojo
DEFECTDOJO_URL = "http://192.168.209.138:8080"
ENGAGEMENT_ID = 3
API_KEY = "XXXXXXXX"  # Replace with your API key

# -------------------------
# Run Semgrep scan
# -------------------------
print(f"Running Semgrep scan on {TARGET_PATH}...")
env = os.environ.copy()
env["SEMGREP_HOME"] = "/tmp/semgrep"

subprocess.run([
    "/home/dipesh/SAST/env/bin/semgrep",
    "--config", SEMGREP_CONFIG,
    TARGET_PATH,
    "--json",
    "-o", SEMGRP_JSON
], check=True, env=env)

print(f"Semgrep scan completed. Results saved to {SEMGRP_JSON}")

# -------------------------
# Upload to DefectDojo
# -------------------------
print("Uploading results to DefectDojo...")

headers = {"Authorization": f"Token {API_KEY}"}

files = {
    'file': ('semgrep_results.json', open(SEMGRP_JSON, 'rb'), 'application/json')
}

data = {
    'engagement': ENGAGEMENT_ID,
    'scan_type': 'Semgrep JSON Report',
    'minimum_severity': 'Low',
    'active': 'true',
    'verified': 'true',
    'tags': 'semgrep,python'
}

upload_url = f"{DEFECTDOJO_URL}/api/v2/import-scan/"

response = requests.post(upload_url, headers=headers, files=files, data=data, verify=False)

if response.status_code in [200, 201]:
    print("Scan successfully uploaded to DefectDojo!")
else:
    print(f"Failed to upload scan. Status: {response.status_code}")
    print(response.text)</code></pre>
</div>

<div class="section">
<h2>Vulnerable Server Example (vul_server.py)</h2>
<pre><code>import os
import pickle
import subprocess
import yaml

# Hardcoded secret (bad practice)
API_KEY = "AKIA123456SECRETKEY"

# Command injection
def run_command(user_input):
    os.system("echo " + user_input)

# Insecure subprocess usage
def ping_host(host):
    subprocess.call("ping -c 1 " + host, shell=True)

# Unsafe YAML deserialization
def load_config(data):
    return yaml.load(data, Loader=yaml.FullLoader)

# Unsafe pickle deserialization
def load_pickle(data):
    return pickle.loads(data)

if __name__ == "__main__":
    run_command("hello; rm -rf /")
    ping_host("127.0.0.1; rm -rf /")
    config = load_config("!!python/object/apply:os.system ['ls']")
    print(config)</code></pre>
</div>

<div class="section">
<h2>Execution</h2>
<div class="log">
<pre><code>root@test-server:/home/dipesh/SAST# python3 sastscript.py
Running Semgrep scan on /home/dipesh/SAST...

┌──── ○○○ ────┐
│ Semgrep CLI │
└─────────────┘

Scanning 4650 files with 151 rules...

┌──────────────┐
│ Scan Summary │
└──────────────┘
✅ Scan completed successfully.
 • Findings: 44 (44 blocking)
 • Rules run: 151
 • Targets scanned: 2107
 • Parsed lines: ~100.0%

Semgrep scan completed. Results saved to /tmp/semgrep_results.json
Uploading results to DefectDojo...
Scan successfully uploaded to DefectDojo!</code></pre>
</div>
</div>

<div class="section">
<h2>Explanation</h2>
<p>
The script runs Semgrep on all Python files in the target directory, identifies vulnerabilities such as unsafe <code>subprocess</code> calls, YAML/pickle deserialization issues, and command injection, then uploads the findings to DefectDojo for tracking.
</p>
</div>

<div class="section">
<h2>Mitigation</h2>
<ul>
  <li>Validate all inputs to avoid command injection.</li>
  <li>Avoid using <code>shell=True</code> in subprocess unless necessary.</li>
  <li>Do not deserialize untrusted YAML or pickle data.</li>
  <li>Use secure storage for secrets and API keys.</li>
  <li>Run static analysis tools regularly and integrate into CI/CD.</li>
</ul>
</div>

</body>
</html>
